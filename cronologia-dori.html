<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronologies ARA Multimèdia</title>
    
    <!-- Librerías -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { background-color: #f3f4f6; margin: 0; font-family: sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Estils per al contenidor de preview */
        .preview-wrapper {
            background: white;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-radius: 0.5rem;
            overflow: hidden;
            border: 1px solid #e5e7eb;
            position: relative;
        }
        
        /* Asegurar que box-sizing es respecta */
        * { box-sizing: border-box; }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONES ---
        const IconPlus = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
        const IconTrash = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>;
        const IconEye = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>;
        const IconDownload = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>;
        const IconEdit = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>;
        const IconImage = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>;
        const IconFileText = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>;
        const IconArrowUp = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>;
        const IconArrowDown = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg>;
        const IconLink = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>;
        const IconSave = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>;
        const IconFolderOpen = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>;
        const IconRefresh = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>;
        const IconMonitor = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>;
        const IconSmartphone = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg>;
        
        const IconLeft = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M15 18l-6-6 6-6"/></svg>;
        const IconRight = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M9 18l6-6-6-6"/></svg>;

        const BrandColors = {
            blue: '#5fb4e4',
            black: '#1a1a1a',
            white: '#ffffff',
            grey: '#f4f4f4',
            line: '#e5e5e5',
            tick: '#d1d5db'
        };

        const MONTHS_ES = {
            enero: 0, gener: 0, jan: 0, february: 1, febrero: 1, febrer: 1, mar: 2, marzo: 2, març: 2, abr: 3, abril: 3, may: 4, mayo: 4, maig: 4, 
            jun: 5, junio: 5, juny: 5, jul: 6, julio: 6, juliol: 6, ago: 7, agosto: 7, agost: 7, sep: 8, septiembre: 8, setembre: 8, 
            oct: 9, octubre: 9, nov: 10, noviembre: 10, noviembre: 10, dic: 11, diciembre: 11, desembre: 11
        };

        const defaultData = {
            cover: {
                headline: "Cronologia del Projecte",
                text: "Una història contada pas a pas.",
                media: "https://images.unsplash.com/photo-1504711434969-e33886168f5c?auto=format&fit=crop&q=80&w=1000",
                caption: "Portada"
            },
            events: [
                { id: 1, date: "24/10/2024", headline: "Dia 1", text: "Primer esdeveniment de la sèrie.", media: "https://images.unsplash.com/photo-1556761175-5973dc0f32e7?auto=format&fit=crop&q=80&w=800", caption: "Foto 1", links: "Més info | https://aramultimedia.com" },
                { id: 2, date: "25/10/2024", headline: "Dia 2", text: "Segon esdeveniment.", media: "", caption: "", links: "" }
            ]
        };

        const extractYear = (dateStr) => {
            if (!dateStr) return null;
            const match = dateStr.toString().match(/\d{4}/);
            return match ? parseInt(match[0]) : null;
        };

        const calculatePositionInYear = (dateStr) => {
            if (!dateStr) return 50; 
            const lowerStr = dateStr.toString().trim().toLowerCase();
            let dayOfYear = 180; 

            const dmyMatch = lowerStr.match(/^(\d{1,2})\s*[\/\-]\s*(\d{1,2})\s*[\/\-]\s*(\d{4})$/);
            if (dmyMatch) {
                const d = parseInt(dmyMatch[1]);
                const m = parseInt(dmyMatch[2]) - 1; 
                const y = parseInt(dmyMatch[3]);
                const dateObj = new Date(y, m, d);
                if (!isNaN(dateObj.getTime())) {
                    const start = new Date(y, 0, 0);
                    const diff = dateObj - start;
                    const oneDay = 1000 * 60 * 60 * 24;
                    dayOfYear = Math.floor(diff / oneDay);
                    let percentage = (dayOfYear / 366) * 100; 
                    return Math.min(Math.max(percentage, 0.5), 99.5); 
                }
            }

            let monthIndex = -1; let day = 15;
            for (const [key, val] of Object.entries(MONTHS_ES)) { if (lowerStr.includes(key)) { monthIndex = val; break; } }
            const dayMatch = lowerStr.match(/\b\d{1,2}\b/); 
            if (dayMatch) { const d = parseInt(dayMatch[0]); if (d > 0 && d <= 31) day = d; }
            
            if (monthIndex !== -1) { dayOfYear = (monthIndex * 30.4) + day; } 
            else {
                if (/^\d{4}$/.test(dateStr.trim())) return 50;
                const parsedDate = new Date(dateStr);
                if (!isNaN(parsedDate.getTime())) {
                    const start = new Date(parsedDate.getFullYear(), 0, 0);
                    const diff = parsedDate - start;
                    const oneDay = 1000 * 60 * 60 * 24;
                    dayOfYear = Math.floor(diff / oneDay);
                }
            }
            let percentage = (dayOfYear / 365) * 100;
            return Math.min(Math.max(percentage, 2), 98); 
        };

        const parseLinks = (linksStr) => {
            if (!linksStr) return [];
            return linksStr.split('\n').filter(l => l.trim() !== '').map(l => {
                const parts = l.split('|');
                if (parts.length > 1) {
                    return { text: parts[0].trim(), url: parts.slice(1).join('|').trim() };
                }
                return { text: l.trim(), url: l.trim() };
            });
        };

        function TimelineApp() {
            const [mode, setMode] = useState('editor'); 
            const [previewDevice, setPreviewDevice] = useState('pc'); 
            const [data, setData] = useState(() => {
                const saved = localStorage.getItem('timeline_project_data');
                return saved ? JSON.parse(saved) : defaultData;
            });
            const fileInputRef = useRef(null);

            useEffect(() => {
                localStorage.setItem('timeline_project_data', JSON.stringify(data));
            }, [data]);

            const resetData = () => { if(confirm("Estàs segur? S'esborrarà tot el contingut actual i no es podrà recuperar.")) setData(defaultData); };
            const exportJSON = () => {
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `backup-projecte-${Date.now()}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            };
            const importJSON = (event) => {
                const fileReader = new FileReader();
                if(event.target.files && event.target.files[0]) {
                    fileReader.readAsText(event.target.files[0], "UTF-8");
                    fileReader.onload = e => {
                        try {
                            const loadedData = JSON.parse(e.target.result);
                            if(loadedData.cover && loadedData.events) { setData(loadedData); alert("Projecte carregat correctament!"); } else { alert("L'arxiu no té el format correcte."); }
                        } catch(error) { alert("Error llegint l'arxiu JSON."); }
                    };
                }
            };
            const updateCover = (field, value) => setData(prev => ({ ...prev, cover: { ...prev.cover, [field]: value } }));
            const updateEvent = (id, field, value) => setData(prev => ({ ...prev, events: prev.events.map(ev => ev.id === id ? { ...ev, [field]: value } : ev) }));
            const addEvent = () => { const newId = Date.now(); setData(prev => ({ ...prev, events: [...prev.events, { id: newId, date: "2024", headline: "Nou pas", text: "", media: "", caption: "", links: "" }] })); };
            const addEventAt = (index) => { const newEvent = { id: Date.now(), date: "2024", headline: "Pas inserit", text: "", media: "", caption: "", links: "" }; const newEvents = [...data.events]; newEvents.splice(index + 1, 0, newEvent); setData(prev => ({ ...prev, events: newEvents })); };
            const moveEvent = (index, direction) => { const newEvents = [...data.events]; if (index + direction < 0 || index + direction >= newEvents.length) return; const temp = newEvents[index]; newEvents[index] = newEvents[index + direction]; newEvents[index + direction] = temp; setData(prev => ({ ...prev, events: newEvents })); };
            const removeEvent = (id) => { if (window.confirm('Estàs segur de borrar aquest pas?')) setData(prev => ({ ...prev, events: prev.events.filter(ev => ev.id !== id) })); };

            const downloadHTML = () => {
                const firstEventYear = data.events.length > 0 ? extractYear(data.events[0].date) : '';
                // CHANGE: Use firstEventYear instead of 'INICI'
                const coverBadge = firstEventYear || 'INICI';

                let html = '<!DOCTYPE html>\n<html lang="ca">\n<head>\n';
                html += '    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n';
                html += '    <title>' + data.cover.headline + '</title>\n';
                html += '    <style>\n';
                html += '        * { box-sizing: border-box; }\n';
                html += '        :root { --brand-blue: #5fb4e4; --brand-black: #1a1a1a; --text-color: #333; --bg-grey: #f4f4f4; --tick-color: #d1d5db; }\n';
                html += '        body { margin: 0; font-family: "Helvetica Neue", Arial, sans-serif; background: #fff; color: var(--text-color); overflow-x: hidden; overflow-y: auto; height: 100dvh; display: flex; flex-direction: column; }\n';
                html += '        .timeline-stage { flex: 1; min-height: 0; position: relative; overflow: hidden; background: #000; width: 100%; display: flex; flex-direction: column; }\n';
                html += '        .timeline-nav { height: 110px; background: var(--bg-grey); border-top: 1px solid #ddd; position: relative; z-index: 20; user-select: none; flex-shrink: 0; padding-top: 15px; }\n';
                html += '        .slides-wrapper { display: flex; transition: transform 0.6s cubic-bezier(0.25, 1, 0.5, 1); height: 100%; width: 100%; }\n';
                html += '        .slide { min-width: 100%; height: 100%; display: flex; flex-direction: row; background: white; }\n';
                html += '        .slide.no-media { justify-content: center; align-items: center; }\n';
                html += '        .media-col { flex: 1.5; background: #111; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }\n';
                html += '        .media-col img { width: 100%; height: 100%; object-fit: contain; }\n';
                html += '        .caption { position: absolute; bottom: 0; left: 0; right: 0; padding: 15px; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); color: white; font-size: 0.85rem; text-align: right; }\n';
                
                // CHANGE: Use margin auto 0 for vertical centering with scroll support
                html += '        .text-col { flex: 1; padding: 20px 80px; display: flex; flex-direction: column; overflow-y: auto; background: white; -webkit-overflow-scrolling: touch; min-width: 0; overflow-wrap: break-word; word-wrap: break-word; word-break: normal; hyphens: auto; }\n';
                html += '        .text-col-inner { margin: auto 0; width: 100%; }\n'; 
                html += '        .slide.no-media .text-col { flex: 0 1 100%; text-align: center; border: none; padding: 40px 80px; justify-content: center; }\n'; 
                html += '        .slide.no-media .date-badge { align-self: center; }\n';
                
                html += '        .date-badge { display: inline-block; background: var(--brand-black); color: var(--brand-blue); padding: 5px 12px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 25px; font-size: 0.9rem; align-self: flex-start; border-radius: 2px; }\n';
                html += '        h2 { font-size: 2.5rem; line-height: 1.1; margin: 0 0 20px 0; color: var(--brand-black); font-weight: 700; overflow-wrap: break-word; word-wrap: break-word; word-break: normal; }\n';
                html += '        p { font-size: 1.1rem; line-height: 1.6; color: #555; max-width: 100%; margin: 0 auto; margin-bottom: 20px; overflow-wrap: break-word; word-wrap: break-word; word-break: normal; }\n';
                html += '        .slide:not(.no-media) p { margin: 0 0 20px 0; }\n';
                html += '        .links-container { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px; max-width: 100%; }\n';
                html += '        .slide.no-media .links-container { justify-content: center; }\n';
                html += '        .slide-link { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border: 1px solid var(--brand-blue); color: var(--brand-blue); text-decoration: none; border-radius: 4px; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; white-space: normal; max-width: 100%; overflow-wrap: break-word; word-break: break-word; text-align: left; }\n';
                html += '        .slide-link:hover { background: var(--brand-blue); color: white; }\n';
                html += '        .nav-container { width: 100%; height: 100%; overflow-x: auto; overflow-y: hidden; position: relative; scroll-behavior: smooth; cursor: grab; display: flex; align-items: center; }\n';
                html += '        .nav-container::-webkit-scrollbar { height: 6px; background: transparent; }\n';
                html += '        .ruler-track { display: flex; align-items: flex-end; padding: 0 50vw; height: 100%; position: relative; min-width: max-content; padding-bottom: 30px; }\n';
                html += '        .ruler-line { position: absolute; left: 0; right: 0; bottom: 30px; height: 1px; background: #ccc; z-index: 0; width: 100%; }\n';
                html += '        .year-block { width: 600px; flex-shrink: 0; height: 100%; position: relative; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; }\n';
                html += '        .year-tick { width: 1px; height: 10px; background: var(--tick-color); position: absolute; left: 0; bottom: 0; z-index: 1; }\n';
                html += '        .year-block[data-decade="true"] .year-tick { height: 20px; background: #999; width: 2px; }\n';
                html += '        .year-label { position: absolute; bottom: -22px; left: 0; transform: translateX(-50%); font-size: 0.8rem; color: #888; font-weight: 600; font-family: monospace; }\n';
                
                html += '        .event-stem-container { position: absolute; bottom: 0; width: 1px; z-index: 5; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; height: 90px; }\n';
                html += '        .event-stem-line { width: 1px; height: 100%; background-color: var(--brand-blue); opacity: 0.6; transition: opacity 0.3s; position: absolute; bottom: 0; }\n';
                html += '        .event-marker { width: 12px; height: 12px; background: var(--brand-blue); border: 2px solid white; border-radius: 50%; cursor: pointer; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 2px 4px rgba(0,0,0,0.15); position: absolute; transform: translate(0, 50%); bottom: 0; }\n';
                html += '        .event-stem-container:hover { z-index: 30; } .event-stem-container:hover .event-stem-line { opacity: 1; background-color: var(--brand-black); width: 2px; } .event-stem-container:hover .event-marker { transform: translate(0, 50%) scale(1.3); background: var(--brand-black); border-color: var(--brand-blue); } .event-stem-container:hover .event-tooltip { opacity: 1; }\n';
                html += '        .event-stem-container.active { z-index: 20; } .event-stem-container.active .event-stem-line { opacity: 1; background-color: var(--brand-black); width: 2px; } .event-stem-container.active .event-marker { transform: translate(0, 50%) scale(1.5); background: var(--brand-black); border-color: var(--brand-blue); box-shadow: 0 6px 12px rgba(0,0,0,0.2); } .event-stem-container.active .event-tooltip { opacity: 1; }\n';
                html += '        .event-tooltip { position: absolute; top: 0; left: 50%; transform: translateX(-50%); background: var(--brand-black); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.2); font-weight: bold; }\n';
                
                // NO start-marker (as requested)
                
                // Buttons fixed
                html += '        .float-btn { position: absolute; top: 50%; transform: translateY(-50%); width: 44px; height: 44px; background: white; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 30; border: none; cursor: pointer; color: var(--brand-blue); font-size: 20px; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }\n';
                html += '        .float-btn:hover { background: var(--brand-blue); color: white; }\n';
                html += '        .prev-slide { left: 20px; } .next-slide { right: 20px; }\n';
                
                html += '        @media (max-width: 900px) {\n';
                html += '            .slide { flex-direction: column; }\n';
                html += '            .media-col { flex: 0 0 28vh; height: 28vh; width: 100%; min-height: 180px; }\n';
                html += '            .media-col img { object-fit: cover; }\n';
                // FIX: Reduced padding top, added padding bottom, smaller text sizes
                html += '            .text-col { flex: 1; width: 100%; padding: 20px 60px 40px 60px; border-top: 4px solid var(--brand-blue); overflow-y: auto; display: block; }\n';
                html += '            .text-col-inner { margin: auto 0; min-height: 100%; display: flex; flex-direction: column; justify-content: center; }\n';
                html += '            .slide.no-media .text-col { padding: 40px 60px; }\n';
                html += '            h2 { font-size: 1.15rem; margin-bottom: 12px; }\n';
                html += '            p { font-size: 0.85rem; margin-bottom: 15px; }\n';
                html += '            .timeline-nav { height: 145px; }\n';
                html += '            .year-block { width: 300px; height: 75px; }\n';
                html += '            .ruler-track { padding-bottom: 35px; }\n';
                html += '            .ruler-line { bottom: 35px; }\n';
                html += '            .year-label { bottom: -20px; font-size: 0.75rem; }\n';
                html += '            .event-stem-container { bottom: 0; }\n';
                // No start marker styles
                html += '            .float-btn { top: 50%; transform: translateY(-50%); }\n';
                html += '            .prev-slide { left: 10px; }\n';
                html += '            .next-slide { right: 10px; }\n';
                html += '        }\n';
                html += '    </style>\n</head>\n<body>\n';

                html += '<div class="timeline-stage">\n';
                html += '    <div class="slides-wrapper" id="slider">\n';
                
                html += '        <div class="slide ' + (!data.cover.media ? 'no-media' : '') + ' active">\n';
                if(data.cover.media) {
                    html += '            <div class="media-col"><img src="' + data.cover.media + '" alt="Portada"><div class="caption">' + (data.cover.caption || '') + '</div></div>\n';
                }
                html += '            <div class="text-col"><div class="text-col-inner"><div class="date-badge">' + coverBadge + '</div><h2>' + data.cover.headline + '</h2><p>' + data.cover.text + '</p></div></div>\n';
                html += '        </div>\n';

                data.events.forEach(ev => {
                    const hasMedia = ev.media && ev.media.trim() !== "";
                    let linksHTML = '';
                    if (ev.links) {
                        const linkList = ev.links.split(/\n/).filter(l => l.trim() !== '');
                        if (linkList.length > 0) {
                            linksHTML = '<div class="links-container">';
                            linkList.forEach(l => {
                                const parts = l.split('|');
                                const text = parts[0].trim();
                                const url = parts.length > 1 ? parts.slice(1).join('|').trim() : parts[0].trim();
                                linksHTML += '<a href="' + url + '" target="_blank" class="slide-link">' + text + ' <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg></a>';
                            });
                            linksHTML += '</div>';
                        }
                    }
                    
                    const mediaHTML = hasMedia ? '<div class="media-col"><img src="' + ev.media + '" alt="' + ev.headline + '"><div class="caption">' + (ev.caption || '') + '</div></div>' : '';
                    
                    const textContent = '<div class="text-col-inner">' +
                        '<div class="date-badge">' + ev.date + '</div>' +
                        '<h2>' + ev.headline + '</h2>' +
                        '<p>' + ev.text + '</p>' +
                        linksHTML +
                        '</div>';
                    
                    const textHTML = '<div class="text-col"' + (!hasMedia ? ' style="justify-content: center;"' : '') + '>' + textContent + '</div>';

                    html += '        <div class="slide ' + (!hasMedia ? 'no-media' : '') + '">' + mediaHTML + textHTML + '</div>\n';
                });

                html += '    </div>\n';
                html += '    <button class="float-btn prev-slide" id="btnPrev"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg></button>\n';
                html += '    <button class="float-btn next-slide" id="btnNext"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg></button>\n';
                html += '</div>\n';

                html += '<div class="timeline-nav">\n    <div class="nav-container" id="navContainer">\n        <div class="ruler-track" id="rulerTrack">\n            <div class="ruler-line"></div>\n        </div>\n    </div>\n</div>\n';

                html += '<script>\n';
                html += '    const rawEvents = ' + JSON.stringify(data.events) + ';\n';
                html += '    const MONTHS_ES = { enero: 0, gener: 0, jan: 0, february: 1, febrero: 1, febrer: 1, mar: 2, marzo: 2, març: 2, abr: 3, abril: 3, may: 4, mayo: 4, maig: 4, jun: 5, junio: 5, juny: 5, jul: 6, julio: 6, juliol: 6, ago: 7, agosto: 7, agost: 7, sep: 8, septiembre: 8, setembre: 8, oct: 9, octubre: 9, nov: 10, noviembre: 10, noviembre: 10, dic: 11, diciembre: 11, desembre: 11 };\n';
                html += '    const extractYear = (d) => { const m = d.match(/\\d{4}/); return m ? parseInt(m[0]) : null; };\n';
                html += '    const calculatePosition = (dateStr) => {\n';
                html += '      if (!dateStr) return 50;\n';
                html += '      const lowerStr = dateStr.toString().trim().toLowerCase();\n';
                html += '      let dayOfYear = 180;\n';
                html += '      const dmyMatch = lowerStr.match(/^(\\d{1,2})\\s*[\\/\\-]\\s*(\\d{1,2})\\s*[\\/\\-]\\s*(\\d{4})$/);\n';
                html += '      if (dmyMatch) {\n';
                html += '          const d = parseInt(dmyMatch[1]); const m = parseInt(dmyMatch[2]) - 1; const y = parseInt(dmyMatch[3]);\n';
                html += '          const dateObj = new Date(y, m, d);\n';
                html += '          if (!isNaN(dateObj.getTime())) {\n';
                html += '              const start = new Date(y, 0, 0);\n';
                html += '              const oneDay = 1000 * 60 * 60 * 24;\n';
                html += '              dayOfYear = Math.floor((dateObj - start) / oneDay);\n';
                html += '              return Math.min(Math.max((dayOfYear / 366) * 100, 0.5), 99.5);\n';
                html += '          }\n';
                html += '      }\n';
                html += '      let monthIndex = -1; let day = 15;\n';
                html += '      for (const [key, val] of Object.entries(MONTHS_ES)) { if (lowerStr.includes(key)) { monthIndex = val; break; } }\n';
                html += '      const dayMatch = lowerStr.match(/\\b\\d{1,2}\\b/);\n';
                html += '      if (dayMatch) { const d = parseInt(dayMatch[0]); if (d > 0 && d <= 31) day = d; }\n';
                html += '      if (monthIndex !== -1) { dayOfYear = (monthIndex * 30.4) + day; }\n';
                html += '      else {\n';
                html += '        if (/^\\d{4}$/.test(dateStr.trim())) return 50;\n';
                html += '        const parsedDate = new Date(dateStr);\n';
                html += '        if (!isNaN(parsedDate.getTime())) {\n';
                html += '           const start = new Date(parsedDate.getFullYear(), 0, 0);\n';
                html += '           dayOfYear = Math.floor((parsedDate - start) / (1000 * 60 * 60 * 24));\n';
                html += '        }\n';
                html += '      }\n';
                html += '      return Math.min(Math.max((dayOfYear / 365) * 100, 2), 98);\n';
                html += '    };\n';
                
                html += '    const eventsWithYear = rawEvents.map((e, i) => ({ ...e, originalIndex: i + 1, year: extractYear(e.date) }));\n';
                html += '    const validYears = eventsWithYear.filter(e => e.year !== null).map(e => e.year);\n';
                html += '    let minYear = validYears.length ? Math.min(...validYears) - 1 : new Date().getFullYear();\n';
                html += '    let maxYear = validYears.length ? Math.max(...validYears) : new Date().getFullYear();\n';
                // CHANGE: No substracting year from start
                html += '    minYear -= 0; maxYear += 2;\n';
                
                html += '    const rulerTrack = document.getElementById("rulerTrack");\n';
                // CHANGE: Removed start marker from timeline
                
                html += '    for (let y = minYear; y <= maxYear; y++) {\n';
                html += '        const block = document.createElement("div");\n';
                html += '        block.className = "year-block";\n';
                html += '        if (y % 10 === 0) block.dataset.decade = "true";\n';
                html += '        block.innerHTML = "<div class=\\"year-tick\\"></div><div class=\\"year-label\\">" + y + "</div>";\n';
                html += '        const evsInYear = eventsWithYear.filter(e => e.year === y);\n';
                html += '        evsInYear.sort((a, b) => calculatePosition(a.date) - calculatePosition(b.date));\n';
                html += '        const heightPattern = [40, 25, 10];\n';
                html += '        evsInYear.forEach((ev, localIndex) => {\n';
                html += '            const container = document.createElement("div");\n';
                html += '            container.className = "event-stem-container";\n';
                html += '            container.id = "marker-" + ev.originalIndex;\n';
                html += '            container.style.left = calculatePosition(ev.date) + "%";\n';
                html += '            const stemHeight = heightPattern[localIndex % 3];\n';
                html += '            container.innerHTML = "<div class=\\"event-tooltip\\">" + ev.date + "</div><div class=\\"event-stem-line\\" style=\\"height:" + stemHeight + "px\\"></div><div class=\\"event-marker\\" style=\\"bottom:" + stemHeight + "px\\"></div>";\n';
                html += '            container.onclick = (e) => { e.stopPropagation(); goToSlide(ev.originalIndex); };\n';
                html += '            block.appendChild(container);\n';
                html += '        });\n';
                html += '        rulerTrack.appendChild(block);\n';
                html += '    }\n';
                
                html += '    const slider = document.getElementById("slider");\n';
                html += '    const btnPrev = document.getElementById("btnPrev");\n';
                html += '    const btnNext = document.getElementById("btnNext");\n';
                html += '    const navContainer = document.getElementById("navContainer");\n';
                html += '    let currentIndex = 0; const totalSlides = ' + (data.events.length + 1) + ';\n';
                
                html += '    function goToSlide(index) {\n';
                html += '        if(index < 0 || index >= totalSlides) return;\n';
                html += '        currentIndex = index;\n';
                html += '        slider.style.transform = "translateX(-" + (currentIndex * 100) + "%)";\n';
                html += '        btnPrev.disabled = currentIndex === 0; btnNext.disabled = currentIndex === totalSlides - 1;\n';
                html += '        document.querySelectorAll(".event-stem-container").forEach(m => m.classList.remove("active"));\n';
                html += '        const activeMarker = document.getElementById("marker-" + currentIndex);\n';
                // CHANGE: Center timeline on first marker if on cover
                html += '        let targetMarker = activeMarker;\n';
                html += '        if (currentIndex === 0) targetMarker = document.getElementById("marker-1");\n';
                
                html += '        if(targetMarker) {\n';
                html += '            if (activeMarker) activeMarker.classList.add("active");\n';
                html += '            const containerCenter = navContainer.clientWidth / 2;\n';
                html += '            const markerRect = targetMarker.getBoundingClientRect();\n';
                html += '            const containerRect = navContainer.getBoundingClientRect(); \n';
                html += '            const currentScroll = navContainer.scrollLeft;\n';
                html += '            const scrollTarget = currentScroll + (markerRect.left - containerRect.left - containerCenter + (markerRect.width/2));\n';
                html += '            navContainer.scrollTo({ left: scrollTarget, behavior: "smooth" });\n';
                html += '        }\n';
                html += '    }\n';
                html += '    btnPrev.addEventListener("click", () => goToSlide(currentIndex - 1));\n';
                html += '    btnNext.addEventListener("click", () => goToSlide(currentIndex + 1));\n';
                html += '    document.addEventListener("keydown", (e) => { if (e.key === "ArrowLeft") goToSlide(currentIndex - 1); if (e.key === "ArrowRight") goToSlide(currentIndex + 1); });\n';
                html += '    setTimeout(() => goToSlide(0), 200);\n';
                html += '<\/script>\n</body>\n</html>';

                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url;
                a.download = `cronologia-ara-${data.cover.headline.replace(/\s+/g, '-').toLowerCase()}.html`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            };

            const firstEventYear = data.events.length > 0 ? extractYear(data.events[0].date) : '';
            const coverBadge = firstEventYear || 'INICI';

            // --- RENDER RECT ---
            return (
                <div className="flex flex-col h-screen bg-gray-50 text-gray-800 font-sans overflow-hidden">
                    <header className="flex-none bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center shadow-sm z-20">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 rounded bg-black flex items-center justify-center text-white font-bold text-lg">C</div>
                            <h1 className="text-xl font-bold tracking-tight text-gray-900">Cronologies <span style={{color: BrandColors.blue}}>ARA Multimèdia</span></h1>
                        </div>
                        <div className="flex gap-3 items-center">
                            <div className="flex bg-gray-100 rounded-md p-1 mr-2">
                                <button onClick={resetData} className="p-2 hover:bg-white rounded text-gray-600" title="Nou Projecte"><IconRefresh /></button>
                                <button onClick={() => fileInputRef.current.click()} className="p-2 hover:bg-white rounded text-gray-600" title="Obrir Projecte"><IconFolderOpen /></button>
                                <button onClick={exportJSON} className="p-2 hover:bg-white rounded text-gray-600" title="Guardar Projecte (Backup)"><IconSave /></button>
                                <input type="file" ref={fileInputRef} onChange={importJSON} style={{display: 'none'}} accept=".json" />
                            </div>
                            
                            <div className="h-6 w-px bg-gray-300 mx-1"></div>

                            {mode === 'preview' && (
                                <div className="flex bg-gray-100 rounded-md p-1 mr-2">
                                    <button 
                                        onClick={() => setPreviewDevice('pc')} 
                                        className={`p-2 rounded ${previewDevice === 'pc' ? 'bg-white shadow' : 'text-gray-500 hover:text-gray-900'}`} 
                                        title="Vista PC (690px)"
                                    >
                                        <IconMonitor />
                                    </button>
                                    <button 
                                        onClick={() => setPreviewDevice('mobile')} 
                                        className={`p-2 rounded ${previewDevice === 'mobile' ? 'bg-white shadow' : 'text-gray-500 hover:text-gray-900'}`} 
                                        title="Vista Mòbil"
                                    >
                                        <IconSmartphone />
                                    </button>
                                </div>
                            )}

                            <button onClick={() => setMode(mode === 'editor' ? 'preview' : 'editor')} className="flex items-center gap-2 px-4 py-2 rounded-md font-medium transition-colors" style={{ backgroundColor: mode === 'editor' ? '#eee' : BrandColors.blue, color: mode === 'editor' ? '#333' : 'white' }}>
                                {mode === 'editor' ? <><IconEye /> Vista Prèvia</> : <><IconEdit /> Editar</>}
                            </button>
                            <button onClick={downloadHTML} className="flex items-center gap-2 px-4 py-2 rounded-md font-medium text-white transition-opacity hover:opacity-90 shadow-md" style={{ backgroundColor: BrandColors.black }}>
                                <IconDownload /> Exportar HTML
                            </button>
                        </div>
                    </header>

                    <div className="flex-1 overflow-hidden relative flex items-center justify-center bg-gray-100">
                        {mode === 'editor' ? (
                            <div className="h-full w-full overflow-y-auto p-8 max-w-4xl mx-auto animate-in fade-in duration-300">
                                <section className="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8 relative overflow-hidden">
                                    <div className="absolute top-0 left-0 w-2 h-full" style={{backgroundColor: BrandColors.black}}></div>
                                    <h2 className="text-xl font-bold mb-6 flex items-center gap-2"><IconImage className="text-gray-400" /> Configuració de la Portada</h2>
                                    <div className="grid gap-5">
                                        <input type="text" value={data.cover.headline} onChange={(e) => updateCover('headline', e.target.value)} className="w-full p-3 border border-gray-300 rounded outline-none" placeholder="Títol Principal" />
                                        <textarea value={data.cover.text} onChange={(e) => updateCover('text', e.target.value)} className="w-full p-3 border border-gray-300 rounded outline-none h-24 resize-none" placeholder="Text Introductori..." />
                                        <div className="grid grid-cols-2 gap-4">
                                            <input type="text" value={data.cover.media} onChange={(e) => updateCover('media', e.target.value)} className="w-full p-3 border border-gray-300 rounded outline-none" placeholder="URL Imatge de Fons" />
                                            <input type="text" value={data.cover.caption} onChange={(e) => updateCover('caption', e.target.value)} className="w-full p-3 border border-gray-300 rounded outline-none" placeholder="Crèdits / Peu de foto" />
                                        </div>
                                    </div>
                                </section>
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-xl font-bold flex items-center gap-2"><IconFileText className="text-gray-400" /> Passos de la Cronologia</h2>
                                    <button onClick={addEvent} className="flex items-center gap-2 px-4 py-2 rounded-full text-white font-medium shadow transition-all" style={{backgroundColor: BrandColors.blue}}><IconPlus /> Afegir Pas Final</button>
                                </div>
                                <div className="space-y-6 pb-20">
                                    {data.events.map((ev, idx) => (
                                        <div key={ev.id} className="relative">
                                            {/* Step Card */}
                                            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                                <div className="bg-gray-50 px-6 py-3 border-b border-gray-100 flex justify-between items-center">
                                                    <div className="flex items-center gap-3">
                                                        <span className="font-bold text-gray-400 text-sm tracking-wider">PAS {idx + 1}</span>
                                                        <div className="flex gap-1 bg-white border rounded p-1">
                                                            <button onClick={() => moveEvent(idx, -1)} disabled={idx === 0} className="p-1 hover:bg-gray-100 rounded disabled:opacity-30"><IconArrowUp /></button>
                                                            <button onClick={() => moveEvent(idx, 1)} disabled={idx === data.events.length - 1} className="p-1 hover:bg-gray-100 rounded disabled:opacity-30"><IconArrowDown /></button>
                                                        </div>
                                                    </div>
                                                    <button onClick={() => removeEvent(ev.id)} className="text-gray-400 hover:text-red-500 p-2"><IconTrash /></button>
                                                </div>
                                                <div className="p-6 grid gap-5">
                                                    <div className="grid grid-cols-12 gap-4">
                                                        <div className="col-span-4">
                                                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Data</label>
                                                            <input type="text" value={ev.date} onChange={(e) => updateEvent(ev.id, 'date', e.target.value)} className="w-full p-2 bg-gray-50 border border-gray-200 rounded focus:bg-white outline-none font-medium text-center" style={{color: BrandColors.blue}} />
                                                        </div>
                                                        <div className="col-span-8">
                                                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Titular</label>
                                                            <input type="text" value={ev.headline} onChange={(e) => updateEvent(ev.id, 'headline', e.target.value)} className="w-full p-2 bg-gray-50 border border-gray-200 rounded focus:bg-white outline-none font-bold" />
                                                        </div>
                                                    </div>
                                                    <textarea value={ev.text} onChange={(e) => updateEvent(ev.id, 'text', e.target.value)} className="w-full p-2 bg-gray-50 border border-gray-200 rounded outline-none h-20 resize-none text-sm" placeholder="Descripció..." />
                                                    <div className="grid grid-cols-2 gap-4">
                                                        <input type="text" value={ev.media} onChange={(e) => updateEvent(ev.id, 'media', e.target.value)} className="w-full p-2 bg-gray-50 border border-gray-200 rounded outline-none text-sm" placeholder="URL Imatge" />
                                                        <input type="text" value={ev.caption} onChange={(e) => updateEvent(ev.id, 'caption', e.target.value)} className="w-full p-2 bg-gray-50 border border-gray-200 rounded outline-none text-sm" placeholder="Peu de foto" />
                                                    </div>
                                                    
                                                    {/* CAMP DE LINKS EXTRA */}
                                                    <div>
                                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1 flex items-center gap-2">
                                                            <IconLink /> Enllaços Extra (Un per línia: "Text | URL" o només "URL")
                                                        </label>
                                                        <textarea 
                                                            value={ev.links || ''} 
                                                            onChange={(e) => updateEvent(ev.id, 'links', e.target.value)}
                                                            className="w-full p-2 bg-gray-50 border border-gray-200 rounded outline-none h-20 resize-none text-sm font-mono text-xs" 
                                                            placeholder="Exemple:&#10;Més informació | https://web.com&#10;https://altra-web.com" 
                                                        />
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div className="flex justify-center py-2 relative group">
                                                <div className="absolute top-1/2 left-0 w-full h-[1px] bg-gray-200 group-hover:bg-blue-200 transition-colors"></div>
                                                <button 
                                                    onClick={() => addEventAt(idx)}
                                                    className="relative z-10 bg-white border border-gray-300 text-gray-400 hover:text-blue-500 hover:border-blue-400 rounded-full p-1 shadow-sm transition-all"
                                                    title="Inserir nou pas ací"
                                                >
                                                    <IconPlus />
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            <div className="absolute inset-0 flex items-center justify-center animate-in zoom-in duration-300 p-8 preview-container">
                                <div style={{
                                    width: previewDevice === 'pc' ? '690px' : '360px',
                                    height: '650px',
                                    transition: 'width 0.3s ease',
                                    boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)',
                                    borderRadius: '8px',
                                    overflow: 'hidden',
                                    border: '1px solid #e5e7eb',
                                    backgroundColor: 'white',
                                    position: 'relative' 
                                }}>
                                    <PreviewComponent data={data} />
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // --- COMPONENTE PREVIEW ---
        function PreviewComponent({ data }) {
            const [currentIndex, setCurrentIndex] = useState(0);
            const scrollRef = useRef(null);
            
            const slides = [{ type: 'cover', ...data.cover }, ...data.events.map(e => ({ type: 'event', ...e }))];
            const next = () => currentIndex < slides.length - 1 && setCurrentIndex(c => c + 1);
            const prev = () => currentIndex > 0 && setCurrentIndex(c => c - 1);
            const goTo = (idx) => setCurrentIndex(idx);
            const currentSlide = slides[currentIndex];

            const eventsWithYear = data.events.map((e, i) => ({ ...e, originalIndex: i + 1, year: extractYear(e.date) }));
            const validYears = eventsWithYear.filter(e => e.year !== null).map(e => e.year);
            let minYear = validYears.length ? Math.min(...validYears) - 1 : new Date().getFullYear() - 1;
            let maxYear = validYears.length ? Math.max(...validYears) + 2 : new Date().getFullYear() + 2;
            const rulerYears = []; for (let y = minYear; y <= maxYear; y++) rulerYears.push(y);

            useEffect(() => {
                if (scrollRef.current) {
                    const activeMarker = document.getElementById(`preview-marker-${currentIndex}`);
                    if (activeMarker) {
                        const containerWidth = scrollRef.current.clientWidth;
                        const markerRect = activeMarker.getBoundingClientRect();
                        const containerRect = scrollRef.current.getBoundingClientRect();
                        const currentScroll = scrollRef.current.scrollLeft;
                        const offsetInView = markerRect.left - containerRect.left;
                        const targetScroll = currentScroll + offsetInView - (containerWidth / 2) + (markerRect.width / 2);
                        scrollRef.current.scrollTo({ left: targetScroll, behavior: 'smooth' });
                    }
                }
            }, [currentIndex]);

            // PARSE LINKS
            const links = currentSlide.links ? parseLinks(currentSlide.links) : [];
            const hasMedia = currentSlide.media && currentSlide.media.trim() !== "";
            const firstEventYear = data.events.length > 0 ? extractYear(data.events[0].date) : '';
            const coverBadge = firstEventYear || 'INICI';

            return (
                <div className="w-full h-full bg-white flex flex-col relative" style={{fontFamily: "'Helvetica Neue', Arial, sans-serif"}}>
                    <div className="flex-1 relative overflow-hidden flex flex-col bg-white">
                        
                        {/* CONDITIONAL MEDIA COLUMN */}
                        {hasMedia && (
                            <div className="bg-black relative flex items-center justify-center overflow-hidden" style={{flex: '0 0 28%', height: '28%', width: '100%', minHeight: '180px'}}>
                                <img src={currentSlide.media} alt={currentSlide.headline} className="w-full h-full object-cover opacity-100" />
                                {currentSlide.caption && ( <div className="absolute bottom-0 left-0 right-0 p-3 bg-gradient-to-t from-black/80 to-transparent text-white text-xs text-right"> {currentSlide.caption} </div> )}
                            </div>
                        )}

                        {/* TEXT COLUMN */}
                        <div className={`flex-1 flex flex-col relative bg-white overflow-y-auto`} 
                             style={{padding: '20px 60px 40px 60px', width: '100%'}}>
                             
                             {/* Content centered vertically if no image */}
                             <div className={`w-full h-full flex flex-col ${!hasMedia ? 'justify-center' : ''}`} style={{ margin: 'auto 0' }}>
                                <div className="w-full">
                                    <span className={`inline-block px-3 py-1 mb-3 text-xs font-bold tracking-widest text-white bg-gray-900 rounded-sm ${!hasMedia ? 'mx-auto block w-max' : ''}`}>
                                    {currentSlide.type === 'event' ? currentSlide.date : coverBadge}
                                    </span>
                                    <h2 className="text-2xl font-bold text-gray-900 mb-3 leading-tight" style={{overflowWrap: 'break-word', wordBreak: 'normal', textAlign: !hasMedia ? 'center' : 'left'}}>{currentSlide.headline}</h2>
                                    <p className="text-base text-gray-600 leading-relaxed mb-4" style={{overflowWrap: 'break-word', wordBreak: 'normal', textAlign: !hasMedia ? 'center' : 'left'}}>{currentSlide.text}</p>
                                    
                                    {/* LINKS DISPLAY */}
                                    {links.length > 0 && (
                                        <div className={`mt-4 flex flex-wrap gap-2 ${!hasMedia ? 'justify-center' : ''}`}>
                                            {links.map((link, i) => (
                                                <a key={i} href={link.url} target="_blank" rel="noopener noreferrer" 
                                                className="inline-flex items-center gap-2 px-3 py-2 border border-blue-400 text-blue-500 rounded hover:bg-blue-500 hover:text-white transition-colors text-sm font-bold"
                                                style={{whiteSpace: 'normal', textAlign: 'left', wordBreak: 'break-word'}}>
                                                    {link.text} <IconLink />
                                                </a>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                        
                        {/* FLECHAS DE NAVEGACIÓN FIJAS (Siempre centradas en el contenedor principal) */}
                        <button onClick={prev} disabled={currentIndex === 0} 
                            className="absolute left-2 top-1/2 -translate-y-1/2 w-10 h-10 bg-white/90 rounded-full shadow-md flex items-center justify-center transition-all disabled:opacity-0 hover:bg-white text-blue-400 border border-gray-200 z-30" 
                            style={{color: BrandColors.blue}}> <IconLeft /> 
                        </button>
                        <button onClick={next} disabled={currentIndex === slides.length - 1} 
                            className="absolute right-2 top-1/2 -translate-y-1/2 w-10 h-10 bg-white/90 rounded-full shadow-md flex items-center justify-center transition-all disabled:opacity-0 hover:bg-white text-blue-400 border border-gray-200 z-30" 
                            style={{color: BrandColors.blue}}> <IconRight /> 
                        </button>

                    </div>

                    <div className="border-t border-gray-300 relative flex items-center flex-none z-10 select-none bg-gray-100" style={{height: '110px'}}>
                        <div ref={scrollRef} className="w-full h-full overflow-x-auto overflow-y-hidden relative no-scrollbar" style={{scrollbarWidth: 'none'}}>
                            <div className="flex items-end h-full px-[50vw] relative min-w-max" style={{paddingBottom: '30px'}}>
                                <div className="absolute left-0 right-0 h-[1px] bg-gray-300 z-0 w-full" style={{bottom: '30px'}}></div>
                                
                                {rulerYears.map((year) => {
                                    const eventsInThisYear = eventsWithYear.filter(e => e.year === year);
                                    
                                    // 1. ORDENAR EVENTOS DEL AÑO CRONOLÓGICAMENTE
                                    eventsInThisYear.sort((a, b) => calculatePositionInYear(a.date) - calculatePositionInYear(b.date));
                                    
                                    // 2. PATRÓN DE ALTURA DESCENDENTE (Alto -> Medio -> Bajo)
                                    const heightPattern = [40, 25, 10]; 

                                    return (
                                        <div key={year} className="w-[300px] h-full flex-shrink-0 relative flex flex-col justify-end items-center">
                                            <div className={`w-[1px] absolute left-0 bottom-0 z-1 bg-gray-300 ${year % 10 === 0 ? 'h-5 w-[2px] bg-gray-400' : 'h-2.5'}`}></div>
                                            <div className="absolute left-0 -translate-x-1/2 text-xs text-gray-500 font-bold font-mono" style={{bottom: '-20px'}}>{year}</div>
                                            {eventsInThisYear.map((ev, localIndex) => {
                                                const isActive = currentIndex === ev.originalIndex;
                                                const leftPos = calculatePositionInYear(ev.date);
                                                
                                                // Asignamos altura basada en el orden (localIndex)
                                                const height = heightPattern[localIndex % 3]; 

                                                return (
                                                    <div key={ev.id} id={`preview-marker-${ev.originalIndex}`} onClick={(e) => { e.stopPropagation(); goTo(ev.originalIndex); }}
                                                        className={`absolute bottom-0 z-10 flex flex-col items-center justify-start group cursor-pointer`}
                                                        style={{ left: `${leftPos}%`, height: '80px', width: '10px', transform: 'translateX(-50%)' }}>
                                                        
                                                        <div className="absolute top-0 left-1/2 -translate-x-1/2 bg-black text-white text-[10px] px-2 py-1 rounded whitespace-nowrap transition-opacity pointer-events-none group-hover:opacity-100 shadow-lg font-bold z-20"
                                                             style={{opacity: isActive ? 1 : 0, top: '0px'}}>{ev.date}</div>

                                                        <div className={`w-[1px] transition-all duration-300 ${isActive ? 'bg-black w-[2px]' : 'bg-blue-400 opacity-60'}`} 
                                                             style={{backgroundColor: isActive ? BrandColors.black : BrandColors.blue, height: height + 'px', position: 'absolute', bottom: 0}}></div>
                                                        
                                                        <div className={`w-3 h-3 rounded-full border-2 border-white absolute transition-all duration-300 shadow-sm left-1/2 -translate-x-1/2 -translate-y-1/2`}
                                                            style={{ backgroundColor: isActive ? BrandColors.black : BrandColors.blue, borderColor: isActive ? BrandColors.blue : 'white', transform: isActive ? 'translate(-50%, -50%) scale(1.5)' : 'translate(-50%, -50%) scale(1)', bottom: height + 'px' }}>
                                                        </div>

                                                    </div>
                                                );
                                            })}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TimelineApp />);
    </script>
</body>
</html>